<!DOCTYPE html>
<html>
<head>
  <title>mid.js sample page</title>
  <meta charset="utf-8"/>
  <!--
  <script src="./bin/zip.min.js"></script>
  <script src="./bin/unzip.min.js"></script>
  -->
  <script src="./closure-primitives/base.js"></script>
  <!--
  <script src="./deps.js"></script>
  -->
  <script>
    var USE_TYPEDARRAY = true;
    Object.keys(goog.dependencies_.nameToPath).forEach(function(name) {
      goog.require(name);
    });
    </script>
  <style>
    body {
      font: 18px Helvetica, arial, freesans, clean, sans-serif;
      padding-top: 100px;
      padding-bottom: 50px;
    }
    h1 {
      border-bottom: 2px solid #48f;
      padding: 5px;
      font-size: xx-large;
    }
    h2 {
      border-left: 0.5em solid #444;
      padding-left: 10px;
    }
    canvas {
      margin: 1em;
      border: 1px solid #888;
      padding: 0.5em;
      box-shadow: 5px 5px 6px #ccc;
      -webkit-box-shadow: 5px 5px 6px #ccc;
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 80px;
      background-color: #48f;
      color: white;
      margin-bottom: 100px;
      text-shadow: 1px 1px 2px #444;
      box-shadow: 5px 5px 6px #ccc;
      -webkit-box-shadow: 5px 5px 6px #444;
    }

    footer {
      height: 40px;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #48f;
      color: white;
      text-shadow: 1px 1px 2px #444;
    }
  </style>
</head>

<script>
NodeList.prototype.forEach = Array.prototype.forEach;
window.addEventListener('DOMContentLoaded', function() {
  var url = "hoge";

  var xhr = new XMLHttpRequest();
  xhr.open("GET", url, true);
  xhr.responseType = 'arraybuffer';
  xhr.addEventListener('load', function() {
    var data = new Uint8Array(xhr.response);
    var password = "hogehoge".split('').map(function(a) { return a.charCodeAt(0); });

    var zip = new Zlib.Zip();
    zip.setPassword(password);
    zip.addFile(data, {
      filename: 'hoge2'.split('').map(function(a) { return a.charCodeAt(0); })
    });
    var zipped = zip.compress();

    var hoge = new Zlib.Unzip(zipped, {
      password: password,
      verify: true
    });
    var files = hoge.getFilenames();
    console.log("files", files);
    hoge.setPassword(password);
    var decripted = hoge.decompress(files[0]);
    console.log("first file", decripted);
    console.log(String.fromCharCode.apply(null, decripted));
  }, false);
  xhr.send();

  /*
  var url = "hoge.zip";

  var xhr = new XMLHttpRequest();
  xhr.open("GET", url, true);
  xhr.responseType = 'arraybuffer';
  xhr.addEventListener('load', function() {
    var data = new Uint8Array(xhr.response);
    var password = "hogehoge".split('').map(function(a) { return a.charCodeAt(0); });
    var hoge = new Zlib.Unzip(data, {
      //password: password,
      verify: true
    });
    var files = hoge.getFilenames();
    console.log("files", files);
    hoge.setPassword(password);
    var decripted = hoge.decompress(files[0]);
    console.log("first file", decripted);
    console.log(String.fromCharCode.apply(null, decripted));
  }, false);
  xhr.send();
  */

  /*
  var key = new Array(3);

  function decrypt_byte() {
    var tmp = ((key[2] & 0xFFFF) | 2);
    return ((tmp * (tmp ^ 1)) >> 8) & 0xff;
  }

  function encode(n) {
    update_keys(n);
    return (n ^ decrypt_byte());
  }

  function InitZipCrypt(char *password, unsigned char cryptheader[], unsigned int crc32)
  {
    key[0] = 305419896;
    key[1] = 591751049;
    key[2] = 878082192;

    for (var i = 0, il = password.length; i < il; ++i) {
      update_keys(password[i]);
    }

    var cryptheader = [];
    for(i = 0, il = 12; i < il; ++i) {
      if(i == 12 - 1){
        cryptheader[i] = crc32 & 0xff;
      }else{
        cryptheader[i] = Math.random() * 256 | 0;
      }
      cryptheader[i] = encode(cryptheader[i]);
    }
  }
  */

  /*
  var zip = new Zlib.Zip();
  zip.addFile(str2array('hoge'), {
    'filename': str2array('hoge.txt'),
    'compress': true,
    'noCompression': true
  });
  console.log(toDataURL(zip.compress()));
  var unzip = new Zlib.Unzip(zip.compress());
  console.log(unzip.decompress(unzip.getFilenames()[0]));
  */
  //location.href = toDataURL(zip.compress());
}, false);

function str2array(str) {
  return str.split('').map(function(a) { return a.charCodeAt(0); });
}

function toDataURL(array) {
  return 'data:application/zip;base64,' + window.btoa(String.fromCharCode.apply(null, array));
}
</script>
<body>

<header>
<h1>mid.js debug page</h1>
</header>


<footer>
  <input type="file" id="file" name="file" />
</footer>

</body>
</html>